<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Registro de Incidencias</title>
  <meta name="theme-color" content="#003B70" />
  <style>
  :root{
    --primary:#003B70;   /* cabecera */
    --accent:#4AC66C;    /* botón principal */
    --bg:#f6f7fb;        /* fondo app */
    --card:#ffffff;      /* fondo tarjeta */
    --muted:#6b7280;
    --radius:16px;
    --shadow:0 10px 22px rgba(0,0,0,.08);
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Poppins", "Noto Sans";
    background:var(--bg);
    color:#111827;
    font-size:17px; /* +1 px global */
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Barra superior con 3 logos (JPG) */
  .topbar{
    position:sticky; top:0; z-index:50;
    background:#fff;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:8px 12px; border-bottom:1px solid #e5e7eb;
  }
  .topbar .logo{ height:42px; width:auto; object-fit:contain; }   /* antes 36px */
  .topbar .center{ height:50px; }                                 /* antes 44px */
  @media (min-width:480px){
    .topbar .logo{height:48px}    /* antes 42px */
    .topbar .center{height:62px}  /* antes 56px */
  }

  .app{ min-height:100%; display:flex; flex-direction:column; align-items:center; padding:clamp(12px,3vw,20px); }

  .hero{
    width:100%; max-width:520px;
    background:var(--primary); color:#fff;
    border-radius:20px; box-shadow:var(--shadow);
    padding:18px 16px; text-align:center; margin-top:12px;
  }
  .hero h1{ font-size:clamp(19px,5vw,25px); margin:0 0 4px; font-weight:800; } /* +1 */
  .hero h2{ font-size:clamp(13px,3.5vw,16px); margin:0; font-weight:500; opacity:.95; } /* +1 */

  .card{
    width:100%; max-width:520px;
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px; margin:14px 0 100px;
  }
  .section-title{ font-size:17px; font-weight:700; margin:8px 2px 12px; } /* +1 */

  .field{ margin-bottom:12px; }
  label{ display:block; font-size:14px; font-weight:600; color:#111827; margin:0 0 6px 2px; } /* +1 */
  input[type="text"], input[type="date"], select, textarea{
    width:100%; padding:14px 12px; border:1px solid #e5e7eb; border-radius:12px;
    background:#fff; font-size:16px; outline:none; box-sizing:border-box; /* +1 */
  }
  textarea{ min-height:96px; resize:vertical; }
  .invalid{ border-color:#ef4444; background:#fff5f5; }
  .hidden{ display:none; }
  .hint{ font-size:13px; color:var(--muted); margin:6px 2px 0; } /* +1 */

  #msg{ margin-top:10px; font-weight:600; text-align:center }
  #msg.success{ color:#16a34a }  #msg.error{ color:#dc2626 }

  .fab{
    position:fixed; bottom:18px; left:50%; transform:translateX(-50%);
    width:min(520px, calc(100% - 24px)); display:flex; gap:8px;
  }
  .btn{ appearance:none; border:0; border-radius:14px; padding:14px 16px; font-weight:800; letter-spacing:.2px; cursor:pointer; flex:1; }
  .btn-primary{ background:var(--accent); color:#fff; box-shadow:0 10px 18px rgba(74,198,108,.35); }
  .btn-ghost{ background:#e5e7eb; color:#111827; }
</style>

</head>
<body>
  <!-- BARRA SUPERIOR DE LOGOS (JPG) -->
  <div class="topbar" role="banner">
    <img src="/logos/arcoprime.jpg" alt="Arcoprime" class="logo left">
    <img src="/logos/comida-segura.jpg" alt="Comida Segura — Calidad Arcoprime" class="logo center">
    <img src="/logos/copec.jpg" alt="Copec" class="logo right">
  </div>

  <div class="app">
    <!-- TÍTULO -->
    <header class="hero">
      <h1>Formulario de Registro de Eventos</h1>
      <h2>Comida Segura - Calidad Arcoprime</h2>
    </header>

    <!-- FORM -->
    <main class="card">
      <div class="section-title">Datos Generales</div>

      <div class="field">
        <label for="tienda">Tienda</label>
        <input list="tiendaList" id="tienda" placeholder="Escribe el nombre del local" autocomplete="off" required>
        <datalist id="tiendaList"></datalist>
      </div>

      <div class="field">
        <label for="fecha">Fecha del evento</label>
        <input type="date" id="fecha" required>
      </div>

      <div class="field">
        <label for="nombre">Nombre y Apellido *</label>
        <input type="text" id="nombre" placeholder="Tu nombre completo" required>
      </div>

      <div class="field">
        <label for="apellido">Cargo *</label>
        <input type="text" id="apellido" placeholder="Cargo" required>
      </div>

      <div class="field">
        <label for="tipoEvento">Tipo de Evento</label>
        <select id="tipoEvento" required>
          <option value="">Selecciona...</option>
        </select>
      </div>

      <!-- BLOQUE PLAGA -->
      <section id="blkPlaga" class="hidden">
        <div class="section-title">Detalle — Plaga</div>
        <div class="field">
          <label for="tipoPlaga">Tipo de Plaga</label>
          <select id="tipoPlaga" required></select>
        </div>
        <div class="field">
          <label for="tipoEventoPlaga">Tipo de Evento Plaga</label>
          <select id="tipoEventoPlaga" required></select>
        </div>
        <div class="field">
          <label for="sector">Sector del Hallazgo</label>
          <select id="sector" required></select>
        </div>
        <div class="field">
          <label for="comentarioPlaga">Comentario</label>
          <textarea id="comentarioPlaga" placeholder="Describe brevemente lo encontrado..." required></textarea>
        </div>
      </section>

      <!-- BLOQUE AROMA -->
      <section id="blkAroma" class="hidden">
        <div class="section-title">Detalle — Aroma</div>
        <div class="field">
          <label for="aromaCat">Categoría</label>
          <select id="aromaCat" required></select>
        </div>
        <div class="field">
          <label for="comentarioAroma">Comentario</label>
          <textarea id="comentarioAroma" placeholder="Observaciones..." required></textarea>
        </div>
      </section>

      <!-- BLOQUE QUÍMICO -->
      <section id="blkQuimico" class="hidden">
        <div class="section-title">Detalle — Químico</div>
        <div class="field">
          <label for="quimCat">Categoría</label>
          <select id="quimCat" required></select>
        </div>
        <div class="field">
          <label for="comentarioQuim">Comentario</label>
          <textarea id="comentarioQuim" placeholder="Observaciones..." required></textarea>
        </div>
      </section>

      <p id="msg" role="status" aria-live="polite"></p>
      <p class="hint">Tip: usa el autocompletar para seleccionar la tienda exacta.</p>
    </main>

    <!-- ACCIONES -->
    <div class="fab" role="group" aria-label="Acciones">
      <button class="btn btn-ghost" type="button" id="btnLimpiar">Limpiar</button>
      <button class="btn btn-primary" type="button" id="btnEnviar">Enviar</button>
    </div>
  </div>

  <script>
    let TIENDAS = [];
    const $ = id => document.getElementById(id);
    const show = (el, on)=> el.classList.toggle('hidden', !on);
    function setInvalid(id, inv){ const el = $(id); if (el) el.classList.toggle('invalid', !!inv); }
    function setMsg(t, isErr=false){ const m = $('msg'); m.textContent = t; m.className = isErr? 'error' : 'success'; }

    init();

    async function init() {
      try {
        const r = await fetch('/api/init', { method:'GET' });
        const j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error || 'Error init');

        TIENDAS = j.tiendas || [];
        // datalist tiendas
        const dl = $('tiendaList'); dl.innerHTML = '';
        TIENDAS.forEach(t => { const o = document.createElement('option'); o.value = t.nombre; dl.appendChild(o); });

        // selects
        const fill = (id, arr) => {
          const el = $(id);
          el.innerHTML = '<option value="">Selecciona...</option>';
          (arr||[]).forEach(v => { const o = document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); });
        };
        fill('tipoEvento',       j.tipoEvento);
        fill('tipoEventoPlaga',  j.tipoEventoPlaga);
        fill('tipoPlaga',        j.tipoPlaga);
        fill('sector',           j.sectores);
        fill('aromaCat',         j.catAroma);
        fill('quimCat',          j.catQuimico);
      } catch (e) {
        setMsg('❌ Error cargando catálogos: ' + (e.message||e), true);
      }

      $('tipoEvento').addEventListener('change', onTipoEventoChange);
      $('btnEnviar').addEventListener('click', enviar);
      $('btnLimpiar').addEventListener('click', () => limpiar(true));
      onTipoEventoChange(); // oculta todo al inicio
    }

    function onTipoEventoChange(){
      const v = ($('tipoEvento').value || '').trim().toLowerCase();
      const isQuim = v === 'químico' || v === 'quimico';
      show($('blkPlaga'),   v === 'plaga');
      show($('blkAroma'),   v === 'aroma');
      show($('blkQuimico'), isQuim);
    }

    function validar(){
      ['tienda','fecha','nombre','apellido','tipoEvento','tipoPlaga','tipoEventoPlaga','sector','comentarioPlaga','aromaCat','comentarioAroma','quimCat','comentarioQuim']
        .forEach(id => setInvalid(id, false));

      const errors = [];
      const tienda = $('tienda').value.trim();
      const fecha  = $('fecha').value;
      const nombre = $('nombre').value.trim();
      const cargo  = $('apellido').value.trim();
      const tipo   = $('tipoEvento').value;

      if (!tienda){ errors.push('Debes ingresar una Tienda.'); setInvalid('tienda', true); }
      const existe = TIENDAS.some(t => t.nombre === tienda);
      if (tienda && !existe){ errors.push('La Tienda no coincide con la base.'); setInvalid('tienda', true); }
      if (!fecha){ errors.push('Debes seleccionar la Fecha.'); setInvalid('fecha', true); }
      if (!nombre){ errors.push('Debes ingresar tu Nombre.'); setInvalid('nombre', true); }
      if (!cargo){ errors.push('Debes ingresar tu Cargo.'); setInvalid('apellido', true); }
      if (!tipo){ errors.push('Debes seleccionar el Tipo de Evento.'); setInvalid('tipoEvento', true); }

      if (tipo === 'Plaga') {
        if (!$('tipoPlaga').value){ errors.push('Selecciona el Tipo de Plaga.'); setInvalid('tipoPlaga', true); }
        if (!$('tipoEventoPlaga').value){ errors.push('Selecciona el Tipo de Evento Plaga.'); setInvalid('tipoEventoPlaga', true); }
        if (!$('sector').value){ errors.push('Selecciona el Sector del Hallazgo.'); setInvalid('sector', true); }
        if (!$('comentarioPlaga').value.trim()){ errors.push('Ingresa un comentario (Plaga).'); setInvalid('comentarioPlaga', true); }
      }
      if (tipo === 'Aroma') {
        if (!$('aromaCat').value){ errors.push('Selecciona la categoría de Aroma.'); setInvalid('aromaCat', true); }
        if (!$('comentarioAroma').value.trim()){ errors.push('Ingresa un comentario (Aroma).'); setInvalid('comentarioAroma', true); }
      }
      if (tipo === 'Químico' || tipo === 'Quimico') {
        if (!$('quimCat').value){ errors.push('Selecciona la categoría de Químico.'); setInvalid('quimCat', true); }
        if (!$('comentarioQuim').value.trim()){ errors.push('Ingresa un comentario (Químico).'); setInvalid('comentarioQuim', true); }
      }
      return errors[0] || '';
    }

    async function enviar(){
      const err = validar();
      if (err) return setMsg(err, true);
      setMsg('Enviando…');

      const payload = {
        Tienda_Nombre: $('tienda').value.trim(),
        Fecha_Evento:  $('fecha').value,
        Nombre:        $('nombre').value.trim(),
        Apellido:      $('apellido').value.trim(),
        Tipo_Evento:   $('tipoEvento').value,

        // PLAGA
        Tipo_Evento_Plaga: $('tipoEventoPlaga').value.trim(),
        Tipo_Plaga:        $('tipoPlaga').value,
        Sector_Hallazgo:   $('sector').value,
        Comentario_Plaga:  $('comentarioPlaga').value.trim(),

        // AROMA (1 select -> 3 columnas)
        Dosif_inco_Aroma:  ($('aromaCat').value === 'Dosificación incorrecta') ? 'Dosificación incorrecta' : '',
        Equip_malo_Aroma:  ($('aromaCat').value === 'Equipo con Fallas') ? 'Equipo con Fallas' : '',
        Hurto_Equip_Aroma: ($('aromaCat').value === 'Hurto de Equipo') ? 'Hurto de Equipo' : '',
        Comentario_Aroma:  $('comentarioAroma').value.trim(),

        // QUÍMICO (1 select -> 3 columnas)
        Falla_Dil_Quimico:    ($('quimCat').value === 'Falla en dilutor') ? 'Falla en dilutor' : '',
        Otra_Inci_Quimico:    ($('quimCat').value === 'Otra incidencia') ? 'Otra incidencia' : '',
        Problema_Ped_Quimico: ($('quimCat').value === 'Problema en Pedido') ? 'Problema en Pedido' : '',
        Comentario_Quimico:   $('comentarioQuim').value.trim(),
      };

      try {
        const r = await fetch('/api/submit', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error || 'Error al guardar');
        setMsg('✅ Registro enviado correctamente.');
        limpiar(false);
      } catch (e) {
        setMsg('❌ ' + (e.message||e), true);
      }
    }

    function limpiar(clearMsg=true){
      [
        'tienda','fecha','nombre','apellido','tipoEvento',
        'tipoEventoPlaga','tipoPlaga','sector','comentarioPlaga',
        'aromaCat','comentarioAroma','quimCat','comentarioQuim'
      ].forEach(id => { const el=$(id); if (el) el.value=''; });
      show($('blkPlaga'), false); show($('blkAroma'), false); show($('blkQuimico'), false);
      if (clearMsg) setMsg('');
      window.scrollTo({top:0, behavior:'smooth'});
    }
  </script>
</body>
</html>
